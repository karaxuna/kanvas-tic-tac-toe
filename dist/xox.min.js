!function(n){n.utils={extend:function(n,t,e){e=e||[Array];for(var i,r=0;i=t[r];r++)for(var o in i)if(i.hasOwnProperty(o)){var a=!1;if(e)for(var s=0;s<e.length;s++)i[o]instanceof e[s]&&(a=!0);"object"!=typeof i[o]||null===i[o]||a?n[o]=i[o]:(n[o]=void 0!==n[o]?n[o]:{},this.extend(n[o],[i[o]],e))}return n},setProp:function(n,t,e){for(var i,r=t.split("."),o=n,a=0;i=r[a];a++)a===r.length-1?o[i]=e:o=o[i]=o[i]||{}},getProp:function(n,t){for(var e,i=t.split("."),r=n,o=0;e=i[o];o++){if(o===i.length-1)return r[e];r=r[e]||{}}},findOne:function(n,t,e){for(var i,r=0;i=n[r];r++)var o=this.matchesQuery(i,t);return o?(e&&e(i,r),i):(e&&e(null),null)},matchesQuery:function(n,t){switch(typeof t){case"object":for(var e in t){var i=this.getProp(n,e);if(i!==t[e])return!1}return!0;case"function":return t(n)}},find:function(n,t,e){for(var i,r=[],o=0;i=n[o];o++)this.matchesQuery(i,t)&&r.push(i);return e&&e(r),r},contains:function(n,t,e){for(var i,r=0;i=n[r];r++)if(this.equals(i,t,e))return!0;return!1},any:function(n,t){for(var e,i=0;e=n[i];i++)if(this.matchesQuery(e,t))return!0;return!1},union:function(n,t,e,i){for(var r=[],o=0;o<n.length;o++)r.push(n[o]);for(var o=0;o<t.length;o++){var a=!this.contains(n,t[o],e);a&&r.push(t[o])}return i&&i(r),r},except:function(n,t,e,i){for(var r=[],o=0;o<n.length;o++){var a=n[o];this.contains(t,a,e)||r.push(a)}return i&&i(r),r},max:function(n){for(var t,e=0;e<n.length;e++){var i=n[e];("undefined"==typeof t||i>t)&&(t=i)}return t},equals:function(n,t,e){for(var i in e){var r=this.getProp(n,i),o=this.getProp(t,i);if(r!==o)return!1}return!0},chain:function(n){return function(){return n.apply(this,arguments),this}}}}(window.kanvas=window.kanvas||{}),function(n){var t=n.utils,e=n.EventTarget=function(){var n=this;n._listeners={}};e.prototype={constructor:e,on:t.chain(function(n,t){"undefined"==typeof this._listeners[n]&&(this._listeners[n]=[]),this._listeners[n].push(t)}),trigger:t.chain(function(n,t){if(this._listeners[n]instanceof Array)for(var e=this._listeners[n],i=0,r=e.length;r>i;i++)t instanceof Array?e[i].apply(this,t):e[i].call(this,t)}),removeListener:t.chain(function(n,t){if(this._listeners[n]instanceof Array)for(var e=this._listeners[n],i=0,r=e.length;r>i;i++)if(e[i]===t){e.splice(i,1);break}})}}(window.kanvas=window.kanvas||{}),function(n){n.Vector=function(n,t){var e=this;e.x=n,e.y=t}}(window.kanvas=window.kanvas||{}),function(n){var t=n.utils,e=n.Point=function(n,t){var e=this;e.x=n,e.y=t};t.extend(e.prototype,[{move:t.chain(function(n){var t=this;t.x+=n.x,t.y+=n.y}),copy:function(){var n=this;return new e(n.x,n.y)}}])}(window.kanvas=window.kanvas||{}),function(n){n.Size=function(n,t){var e=this;e.width=n,e.height=t}}(window.kanvas=window.kanvas||{}),function(n){var t=n.utils,e=n.EventTarget,i=n.Point,r=n.Vector,o=n.Mouse=function(n){var t=this;e.call(t),t.container=n,t.down=!1,t.curr=new i(null,null),t.diff=new r(0,0),n.addEventListener("mousemove",function(e){var i=e.clientX-n.offsetLeft+document.body.scrollLeft,r=e.clientY-n.offsetTop+document.body.scrollTop;t.diff.x=i-t.curr.x,t.diff.y=r-t.curr.y,t.curr.x=i,t.curr.y=r,t.trigger("move",e)}),n.addEventListener("mousedown",function(n){t.down=!0,t.trigger("down",n)}),n.addEventListener("mouseup",function(n){t.down=!1,t.trigger("up",n)}),n.addEventListener("click",function(n){t.trigger("click",n)})};t.extend(o.prototype,[e.prototype])}(window.kanvas=window.kanvas||{}),function(n){var t=n.utils,e=n.EventTarget,i=n.Figure=function(n,t){var i=this;e.call(i),i.parent=n,i.position=t};t.extend(i.prototype,[e.prototype,{move:t.chain(function(n){var t=this;t.position.move(n)}),getAbsPosition:function(){var n=this;return n.parent?n.parent.getAbsPosition().copy().move(n.position):n.position}}])}(window.kanvas=window.kanvas||{}),function(n){var t=n.utils,e=n.Font=function(n,t,e){var i=this;i.style=n,i.size=t,i.family=e};t.extend(e.prototype,[{getCombinedText:function(){var n=this,t=n.style,e=n.size,i=n.family,r="";return t&&(r+=t),e&&(r+=(r?" ":"")+e+"px"),i&&(r+=(r?" ":"")+i),r}}])}(window.kanvas=window.kanvas||{}),function(n){var t=n.utils,e=n.Figure,i=n.Size,r=n.Text=function(n,t,i,r,o){var a=this;e.call(a,n,t),a.text=i,a.font=r,a.align=o};t.extend(r.prototype,[e.prototype,{draw:t.chain(function(n){var t=this,e=t.getAbsPosition(),i=t.text,r=t.font,o=t.align,a=n.context;a.textBaseline="top",a.textAlign=o,a.font=r.getCombinedText(),a.fillText(i,e.x,e.y)}),getSize:function(){var n=this,t=n.text,e=n.font,r=document.createElement("canvas").getContext("2d");return r.textBaseline="top",r.font=e.getCombinedText(),new i(r.measureText(t).width,e.size)},pointInside:function(n){var t=this,e=t.getAbsPosition(),i=t.getSize();return n.x>=e.x&&n.x<=e.x+i.width&&n.y>=e.y&&n.y<=e.y+i.height}}])}(window.kanvas=window.kanvas||{}),function(n){var t=n.utils,e=n.Figure,i=(n.Point,n.Vector,n.Line=function(n,t,i,r,o){var a=this;e.call(a,n,t),a.start=i,a.end=r,a.width=o});t.extend(i.prototype,[e.prototype,{draw:t.chain(function(n){var t=this,e=n.context,i=t.getAbsPosition(),r=i.copy().move(t.start),o=i.copy().move(t.end),a=t.width;e.beginPath(),e.lineWidth=a,e.moveTo(r.x,r.y),e.lineTo(o.x,o.y),e.stroke()}),pointInside:function(){return!1}}])}(window.kanvas=window.kanvas||{}),function(n){var t=n.utils,e=n.EventTarget,i=n.Mouse,r=n.Scene=function(n){var t=this;e.call(t),t.context=n,t.figures=[],t.mouse=new i(n.canvas)};t.extend(r.prototype,[e.prototype,{add:t.chain(function(n,t){var e=this;e.figures.splice(void 0===t?e.figures.length-1:t,0,n)}),draw:t.chain(function(){for(var n,t=this,e=0;n=t.figures[e];e++)n.draw(t)}),redraw:t.chain(function(){var n=this;n.clear().draw()}),clear:t.chain(function(){var n=this;n.context.clearRect(0,0,n.context.canvas.width,n.context.canvas.height)})}])}(window.kanvas=window.kanvas||{}),function(n){function t(n,t){{var e=this;e.values={}}e.width=n,e.height=t}t.prototype.iterate=function(n){var t,e,i=this,r=i.width,o=i.height,a=i.values;for(t=0;r>t;t++)for(e=0;o>e;e++)n(t,e,a[t]?a[t][e]:null)},t.prototype.get=function(n,t){var e=this;return e.values[n][t]},t.prototype.set=function(n,t,e){var i=this;i.values[n]=i.values[n]||{},i.values[n][t]=e},n.Matrix=t}(window.xox=window.xox||{}),function(n){function t(n,t,e,i,o,s,u){var c=this,f=new a(t*i.width,e*i.height);r.call(c,n,f),c.i=t,c.j=e,c.size=i,c.letter=o,c.padding=s,c.lineWidth=u}var e=kanvas.Text,i=kanvas.Font,r=kanvas.Figure,o=kanvas.utils,a=kanvas.Point,s=kanvas.Vector;o.extend(t.prototype,[r.prototype,{draw:o.chain(function(n){var t,r,o=this,a=o.letter,u=o.padding,c=(o.lineWidth,o.size.width),f=o.size.height;if(c===f?(t=f,r=new s(t/2,u)):c>f?(t=f,r=new s((c-t)/2+u,u)):(t=c,r=new s(u,(f-t)/2+u)),a){var h=new i("normal",t-2*u,"Arial"),d=new e(o,r,a,h,"center");d.draw(n)}}),pointInside:function(n){var t=this,e=t.getAbsPosition(),i=t.size;return n.x>=e.x&&n.x<=e.x+i.width&&n.y>=e.y&&n.y<=e.y+i.height}}]),n.Block=t}(window.xox=window.xox||{}),function(n){function t(n,t,e,r){var c=this,f=new o(0,0);i.call(c,null,f);var h=c.matrix=new s(n,t);c.lineWidth=e,c.padding=r,h.iterate(function(n,t){h.set(n,t,new u(c,n,t,new a(0,0),null,r,5))})}var e=(kanvas.Circle,kanvas.Line),i=kanvas.Figure,r=kanvas.utils,o=kanvas.Point,a=kanvas.Size,s=n.Matrix,u=n.Block;r.extend(t.prototype,[i.prototype,{clean:r.chain(function(){var n=this;n.matrix.iterate(function(n,t,e){e.letter=null})}),getBlockByAbsPosition:function(n){var t,e=this,i=e.matrix;return i.iterate(function(e,i,r){r.pointInside(n)&&(t=r)}),t},fill:r.chain(function(n,t,e){var i=this,r=i.matrix.width,o=i.matrix.height;if(n>r||0>n||t>o||0>t)throw new Error("Invalid parameters");var a=i.matrix.get(n,t);if(a.letter)throw new Error("Block is already filled");a.letter=e}),draw:r.chain(function(n){{var t=this,i=t.matrix,r=t.matrix.width,s=t.matrix.height,u=t.lineWidth,c=n.context.canvas;t.padding}i.iterate(function(t,e,i){var u=i.size=new a(c.width/r,c.height/s);i.position=new o(t*u.width,e*u.height),i.draw(n)});var f,h,d;for(f=0;r>=f;f++)d=new e(t,new o(0,0),new o(f*c.width/r,0),new o(f*c.width/r,c.height),u),d.draw(n);for(h=0;s>=h;h++)d=new e(t,new o(0,0),new o(0,h*c.height/s),new o(c.width,h*c.height/s),u),d.draw(n)}),pointInside:function(n){return!1}}]),n.Board=t}(window.xox=window.xox||{}),function(n){function t(n){var t=this;n=t.options=o.extend({},[t.defaultOptions,n],[Array,CanvasRenderingContext2D]),r.call(t),t.options=n,t.letters=n.letters,t.turnIndex=n.turnIndex,t.meIndex=n.meIndex,t.winningScore=n.winningScore,t.winner;var a=t.board=new e(n.width,n.height,1,10),s=t.scene=new i(n.context);s.mouse.on("click",function(){var n=a.getBlockByAbsPosition(s.mouse.curr);n&&t.fill(n.i,n.j,!0)}),s.add(a,0),s.draw()}var e=n.Board,i=kanvas.Scene,r=kanvas.EventTarget,o=kanvas.utils;t.prototype.defaultOptions={letters:["X","O"],turnIndex:0,meIndex:null,winningScore:3,width:3,height:3},o.extend(t.prototype,[r.prototype,{restart:o.chain(function(){var n=this;n.board.clean(),n.winner=null,n.turnIndex=n.options.turnIndex,n.scene.redraw()}),fill:o.chain(function(n,t,e){var i=this,r=i.letters,o=r[i.turnIndex],a=r[i.meIndex],s=i.board,u=i.scene;if(i.winner)throw new Error("Game is over");if(e&&a&&a!==o)throw new Error("Not your turn");s.fill(n,t,o),u.redraw(),i.trigger("filled",{i:n,j:t,letter:o});var c=i.check(n,t,o);c?(i.winner=o,i.trigger("over")):i.turnIndex<r.length-1?i.turnIndex+=1:i.turnIndex=0}),check:function(n,t,e){var i=this,r=i.board,o=r.matrix,a=o.width,s=o.height,u=i.winningScore,c=[[1,0],[0,1],[1,-1],[1,1]].some(function(i){for(var r,c=i[0],f=n,h=i[1],d=t,v=1,l=!1;;)if(f+=c,d+=h,0>f||f>=a||0>d||d>=s){if(l)return!1;f=n,d=t,c=-c,h=-h,l=!0}else if(r=o.get(f,d),r.letter===e){if(++v===u)return!0}else{if(l)return!1;f=n,d=t,c=-c,h=-h,l=!0}});return c}}]),n.Game=t}(window.xox=window.xox||{});